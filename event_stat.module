<?php

/**
 * @file
 * Code for the event stat feature.
 */

include_once 'event_stat.features.inc';

function event_stat_menu() {
    $items = array();

    $items['node/add/eventsworkflow'] = array(
    'title' => 'Arrangementsoversigt',
    'menu_name' => 'management',
    'module' => 'menu',
    'language' => 'und',
    'description' => 'Event statistik indholdsoversigt',
    'page callback' => 'drupal_goto',
    'page arguments' => array('eventsworkflow'),
    'access callback' => '_user_has_role',
      'type' => MENU_NORMAL_ITEM,
  );

    return $items;
}

function _user_has_role() {
    global $user;
    $rid = array_search('Event rapportør', $user->roles);
    if (user_has_role($rid)) {
        return TRUE;
    }
    else {
        return FALSE;
    }
}

/**
 * Implements hook_user_login().
 */
function event_stat_user_login(&$edit, $account) {
    global $user;

    // return if no action is required.
   if(_user_has_role()) {
       $_GET['destination'] = '/eventsworkflow';
   }
}

/**
 * Implements template_preprocess_views_view().
 */
function event_stat_preprocess_views_view(&$vars) {
    //logic
    if($vars['name'] == 'klon_af_administration_nodes') {
     $vars['title'] = '<b><a href="/node/add/ding-event">Nyt arrangement</a><span style="margin-left:2em;"><a href="/eventsworkflow">Arrangement oversigt</a></span></b>';
    }
}

function event_stat_field_group_build_pre_render_alter(&$element) {
  $element['ding_campaigns_wrap']['#access'] = FALSE;
  $element['language']['#access'] = FALSE;

  if (isset($element['group_efterbehandling']) && ($element['#id'] == 'ding-event-node-form')) {
    global $user;
    $rid = array_search('Event rapportør', $user->roles);
    $admin = array_search('administrator', $user->roles);
    $role = count($user->roles);
    if (user_has_role($rid) && ($role == '2')) {
        //Check if new node and I'm not the author.
       if (!empty($element['#node']->nid) && ($element['#node']->uid != $user->uid)) {
          $element['title']['#attributes']['readonly'] = TRUE;

          $element['field_ding_event_target'] = $element['group_ding_event_tagging']['field_ding_event_target'];
          unset($element['group_ding_event_tagging']['field_ding_event_target']);
          $element['field_ding_event_target']['#weight'] = "2";
          foreach($element['field_ding_event_target']['und']['#options'] as $index=>$elm) {
           if($index != $element['field_ding_event_target']['und']['#default_value'][0]) {
               unset($element['field_ding_event_target']['und']['#options'][$index]);
           }
          }

          $sdato =  DateTime::createFromFormat('Y-m-d H:i:s', $element['group_ding_event_date_loc_price']['field_ding_event_date']['und'][0]['#default_value']['value']);
          $date = $sdato->format('m/d/Y H:i');
          $element['group_efterbehandling']['field_slutdato']['und'][0]['#title'] = '<br />Startdato: ' . $date . '<br /><br />Slutdato';
       }else{
           $element['group_efterbehandling']['field_slutdato']['und'][0]['#title'] = 'Start og slutdato';
           array_unshift($element['group_efterbehandling']['field_slutdato']['und'][0], $element['group_ding_event_date_loc_price']['field_ding_event_date']['und'][0]['value']);
           $element['field_ding_event_target'] = $element['group_ding_event_tagging']['field_ding_event_target'];
           unset($element['group_ding_event_tagging']['field_ding_event_target']);
           $element['field_ding_event_target']['#weight'] = "2";
       }
       
       $element['field_efterbehandling_workflow']['und'][0]['workflow']['workflow_sid'][31]['#value'] = 31;

       drupal_add_js('jQuery(document).ready(function () { jQuery("legend").contents().unwrap().wrap("<label/>"); });', 'inline');
       $element['title']['#title'] = 'Titel';

       $element['group_ding_event_attachments']['#access'] = FALSE;

       $element['group_ding_event_content']['field_billede_galleri']['#access'] = FALSE;
       $element['group_ding_event_tagging']['#access'] = FALSE;
       $element['field_klub_tilbud']['#access'] = FALSE;
       $element['group_ding_event_ting']['#access'] = FALSE;

       $element['group_ding_event_date_loc_price']['#title'] = '';
       $element['group_ding_event_date_loc_price']['field_ding_event_location']['und'][0]['#title'] = '';
       $element['group_ding_event_date_loc_price']['field_ding_event_location']['und'][0]['name_block']['name_line']['#title'] = 'Sted navn';
       $element['group_ding_event_date_loc_price']['field_ding_event_library']['und']['#options']['_none'] = 'Andet afholdelsessted';

       $element['group_ding_event_date_loc_price']['field_custom_price']['#access'] = FALSE;
       $element['group_ding_event_date_loc_price']['field_ding_event_price']['#access'] = FALSE;
       $element['group_ding_event_date_loc_price']['field_valgfrit_pris']['#access'] = FALSE;
       $element['group_ding_event_date_loc_price']['group_default_ticket_name']['#access'] = FALSE;


       $element['options']['status']['onclick'] = 'return false;';
       $element['author']['#access'] = FALSE;
       $element['revision_information']['#access'] = FALSE;
       $element['capacity']['#access'] = FALSE;
       $element['place2book']['#access'] = FALSE;
       $element['additional_settings']['#attributes']['onclick'] = 'return false;';

       $element['group_ding_event_content'] += array(
      '#states' => array(
        'invisible' => array(
        'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('checked' => TRUE),
        ),
        '#id' => 'group_ding_event_content',
      )
    );

       $element['group_ding_event_images'] += array(
      '#states' => array(
        'invisible' => array(
        'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('checked' => TRUE),
        ),
        '#id' => 'group_ding_event_images',
      )
    );

      $element['group_ding_event_date_loc_price']['group_date']['#access'] = FALSE;

       $element['group_ding_event_date_loc_price']['field_ding_event_date'] += array(
      '#states' => array(
        'invisible' => array(
        'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('checked' => TRUE),
        ),
        '#id' => 'group_ding_event_date_loc_price',
      )
    );

    $name = $element['field_efterbehandling_workflow']['und'][0]['workflow']['workflow_sid']['#options'];
    $key = array_search ('Ubehandlet', $name);
    $element['group_efterbehandling'] += array(
      '#states' => array(
        'invisible' => array(
         'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('value' => $key),
        ),
      '#id' => 'group_efterbehandling',
      )
    );

    $element['field_efterbehandling_workflow'] += array(
      '#states' => array(
        'invisible' => array(
         'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('checked' => TRUE),
        ),
      )
    );

     }
     elseif(user_has_role($admin)) {
        $name = $element['field_efterbehandling_workflow']['und'][0]['workflow']['workflow_sid']['#options'];
        $ubehandlet = array_search ('Ubehandlet', $name);
        $element['group_efterbehandling'] += array(
        '#states' => array(
        'invisible' => array(
         'input[name="field_efterbehandling_workflow[und][0][workflow][workflow_sid]"]' => array('value' => $ubehandlet),
            ),
            '#id' => 'group_efterbehandling',
        )
        );
        }
         else{
         $element['field_efterbehandling_workflow']['#access'] = FALSE;
         $element['group_efterbehandling']['#access'] = FALSE;
     }
  }
}

function event_stat_node_presave($node) {
    global $user;
    $rid = array_search('Event rapportør', $user->roles);
    $role = count($user->roles);
    if (user_has_role($rid) && ($role == '2')) {
    $node->status = NODE_UNPUBLISHED;
    }
}

function event_stat_enable(){
$fname = 'event_stat_user_default_permissions';
$feature = features_get_features($fname);
$components = array_keys($feature->info['features']);
features_revert(array($fname => $components));
drupal_flush_all_caches();
}
